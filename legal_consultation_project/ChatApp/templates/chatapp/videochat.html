<div class="flex gap-4">
  <video id="localVideo" autoplay muted class="w-1/2"></video>
  <video id="remoteVideo" autoplay class="w-1/2"></video>
</div>

<script>
let localVideo = document.getElementById("localVideo");
let remoteVideo = document.getElementById("remoteVideo");

const roomName = "{{ room_name }}";  // Pass from Django view
const ws = new WebSocket(`ws://${window.location.host}/ws/video/${roomName}/`);

let pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
});

pc.onicecandidate = event => {
    if (event.candidate) {
        ws.send(JSON.stringify({ 'candidate': event.candidate }));
    }
};

pc.ontrack = event => {
    remoteVideo.srcObject = event.streams[0];
};

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
    localVideo.srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    ws.onmessage = async e => {
        let data = JSON.parse(e.data);
        if (data.offer) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ answer }));
        } else if (data.answer) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    };

    // Create offer if first to join
    pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ offer }));
    });
});
</script>
